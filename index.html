<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
    }

    body {
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--text-main);
    }

    #loading {
      text-align: center;
      font-size: 1.2rem;
      color: var(--text-muted);
      margin-top: 50px;
    }

    /* --- Desktop First KPI Grid --- */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
      display: none;
    }

    .kpi-card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .kpi-card h3 {
      margin: 0 0 10px 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    .kpi-card .value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--primary);
      margin: 0;
    }

    .kpi-card .sub-value {
      font-size: 0.85rem;
      margin-top: 5px;
    }

    .positive {
      color: #16a34a;
    }

    .negative {
      color: #dc2626;
    }

    /* --- All Time High Section --- */
    .ath-card {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      text-align: center;
      display: none;
      /* Hidden until loaded */
    }

    .ath-card h3 {
      margin: 0 0 15px 0;
      font-size: 1rem;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 10px;
    }

    .ath-list {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
    }

    .ath-item .value {
      font-size: 1.6rem;
      font-weight: bold;
      color: var(--primary);
      margin: 0;
    }

    .ath-item .sub-value {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-top: 5px;
      font-weight: 500;
    }

    /* --- Chart Styles --- */
    .chart-wrapper {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .chart-container {
      position: relative;
      height: 55vh;
      width: 100%;
    }

    /* --- Mobile Responsiveness --- */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .kpi-card {
        padding: 15px 10px;
      }

      .kpi-card .value {
        font-size: 1.4rem;
      }

      .ath-card {
        padding: 15px 10px;
      }

      .ath-list {
        flex-direction: column;
        gap: 15px;
      }

      .ath-item .value {
        font-size: 1.4rem;
      }

      .chart-wrapper {
        padding: 15px 10px;
      }

      .chart-container {
        height: 400px;
      }
    }

    @media (max-width: 400px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <div id="loading">Loading dashboard data...</div>

  <div class="kpi-grid" id="kpiGrid">
    <div class="kpi-card">
      <h3>Today</h3>
      <p class="value" id="kpi-today">--</p>
    </div>
    <div class="kpi-card">
      <h3>Month</h3>
      <p class="value" id="kpi-mtd">--</p>
      <p class="sub-value" id="kpi-mtd-diff">--</p>
    </div>
    <div class="kpi-card">
      <h3>Year</h3>
      <p class="value" id="kpi-ytd">--</p>
      <p class="sub-value" id="kpi-ytd-diff">--</p>
    </div>
    <div class="kpi-card">
      <h3>End of Year Projection</h3>
      <p class="value" id="kpi-proj">--</p>
    </div>
  </div>

  <div class="ath-card" id="athCard">
    <h3>All Time High</h3>
    <div class="ath-list" id="athList">
    </div>
  </div>

  <div class="chart-wrapper" id="chartWrapper">
    <div class="chart-container">
      <canvas id="ytdChart"></canvas>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwG3l4XVyKLplI17_oD_nG4XutSzyeY1MHD7IficZWY_bShM2nWaDE4tGLKB7a-fm87/exec';

    const formatCurrency = (val) => {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
    };

    async function buildDashboard() {
      try {
        const response = await fetch(API_URL, {
          method: 'GET',
          redirect: 'follow'
        });
        const data = await response.json();

        const kpis = data.kpis;

        // --- Year To Date KPI ---
        document.getElementById('kpi-ytd').innerText = formatCurrency(kpis['Total_YTD']);

        const ytdDiff = parseFloat(kpis['Total_YTD_Diff']);
        const ytdPct = parseFloat(kpis['YTD_PCT']);
        const ytdPctFormatted = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(ytdPct);

        const ytdEl = document.getElementById('kpi-ytd-diff');
        ytdEl.innerText = (ytdDiff >= 0 ? '+' : '') + formatCurrency(ytdDiff) + ' (' + (ytdPct >= 0 ? '+' : '') + ytdPctFormatted + ')';
        ytdEl.className = 'sub-value ' + (ytdDiff >= 0 ? 'positive' : 'negative');

        // --- Month To Date KPI ---
        document.getElementById('kpi-mtd').innerText = formatCurrency(kpis['Total_Month']);

        const mtdDiff = parseFloat(kpis['Total_MTD_Diff']);
        const mtdPct = parseFloat(kpis['Month_PCT']);
        const mtdPctFormatted = new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(mtdPct);

        const mtdEl = document.getElementById('kpi-mtd-diff');
        mtdEl.innerText = (mtdDiff >= 0 ? '+' : '') + formatCurrency(mtdDiff) + ' (' + (mtdPct >= 0 ? '+' : '') + mtdPctFormatted + ')';
        mtdEl.className = 'sub-value ' + (mtdDiff >= 0 ? 'positive' : 'negative');

        // --- Today & Projection KPIs ---
        document.getElementById('kpi-today').innerText = formatCurrency(kpis['Total_Today']);
        document.getElementById('kpi-proj').innerText = formatCurrency(kpis['Year_Proj']);

        const ctx = document.getElementById('ytdChart').getContext('2d');

        let lastDataIndex = data.chart.current.findIndex(val => val === null);
        if (lastDataIndex === -1) lastDataIndex = 365;

        // Arrays for the chart
        const currentDataSliced = data.chart.current.slice(0, lastDataIndex);
        const historicalDataSliced = data.chart.historical.slice(0, lastDataIndex);

        // --- Calculate Top 3 Months of All Time ---
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const allMonthsRev = [];

        const currentYear = new Date().getFullYear();
        const priorYear = currentYear - 1;

        // 1. Process Prior Year (Historical Data - Full Array)
        let prevHistCumulative = 0;
        const priorYearMonthly = Array(12).fill(0);
        for (let i = 0; i < data.chart.historical.length; i++) {
          const currentCumulative = data.chart.historical[i] || prevHistCumulative;
          const dailyRev = currentCumulative - prevHistCumulative;

          const d = new Date(priorYear, 0, i + 1);
          priorYearMonthly[d.getMonth()] += dailyRev;

          prevHistCumulative = currentCumulative;
        }

        priorYearMonthly.forEach((rev, index) => {
          if (rev > 0) {
            allMonthsRev.push({ name: `${monthNames[index]} ${priorYear}`, rev: rev });
          }
        });

        // 2. Process Current Year (Current Data - Up to today)
        let prevCurrCumulative = 0;
        const currentYearMonthly = Array(12).fill(0);
        for (let i = 0; i < lastDataIndex; i++) {
          const currentCumulative = currentDataSliced[i] || prevCurrCumulative;
          const dailyRev = currentCumulative - prevCurrCumulative;

          const d = new Date(currentYear, 0, i + 1);
          currentYearMonthly[d.getMonth()] += dailyRev;

          prevCurrCumulative = currentCumulative;
        }

        currentYearMonthly.forEach((rev, index) => {
          if (rev > 0) {
            allMonthsRev.push({ name: `${monthNames[index]} ${currentYear}`, rev: rev });
          }
        });

        // 3. Sort Combined Data and Grab Top 3
        const top3Months = allMonthsRev
          .sort((a, b) => b.rev - a.rev)
          .slice(0, 3);

        // Render the list inside the single card
        const athListContainer = document.getElementById('athList');
        athListContainer.innerHTML = '';

        top3Months.forEach((month, index) => {
          const item = document.createElement('div');
          item.className = 'ath-item';
          item.innerHTML = `
            <p class="value">${formatCurrency(month.rev)}</p>
            <p class="sub-value">#${index + 1} &bull; ${month.name}</p>
          `;
          athListContainer.appendChild(item);
        });

        // --- Chart Configuration ---
        const labels = Array.from({ length: lastDataIndex }, (_, i) => {
          const d = new Date(new Date().getFullYear(), 0, i + 1);
          return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Current Year',
                data: currentDataSliced,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.1,
                pointRadius: 0,
                pointHoverRadius: 5
              },
              {
                label: 'Prior Year',
                data: historicalDataSliced,
                borderColor: '#94a3b8',
                borderDash: [5, 5],
                borderWidth: 2,
                fill: false,
                tension: 0.1,
                pointRadius: 0,
                pointHoverRadius: 5
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              title: { display: true, text: 'YTD Revenue Pacing', font: { size: 16 } },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || '';
                    if (label) { label += ': '; }
                    if (context.parsed.y !== null) {
                      label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                    }
                    return label;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  maxRotation: 0,
                  autoSkip: false,
                  callback: function (value, index) {
                    const d = new Date(new Date().getFullYear(), 0, index + 1);
                    if (d.getDate() === 1) {
                      return d.toLocaleDateString('en-US', { month: 'short' });
                    }
                    return null;
                  }
                }
              },
              y: {
                title: { display: true, text: 'Cumulative Sales' },
                ticks: { callback: function (value) { return '$' + value.toLocaleString(); } }
              }
            }
          }
        });

        // Show all the components once data is loaded
        document.getElementById('loading').style.display = 'none';
        document.getElementById('kpiGrid').style.display = 'grid';
        document.getElementById('athCard').style.display = 'block';
        document.getElementById('chartWrapper').style.display = 'block';

      } catch (error) {
        console.error('Error fetching dashboard data:', error);
        document.getElementById('loading').innerText = 'Error loading dashboard. Please check the Web App URL.';
      }
    }

    buildDashboard();
  </script>
</body>

</html>